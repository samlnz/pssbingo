<!-- ethio-mini-app/index.html -->
<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ã®·â£·äï·ä≠ ·âµ·à´·äï·àµ·çà·à≠ ·ã≥·àΩ·â¶·à≠·ãµ | Ethiopian Bank Transfer Dashboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #006400; /* Ethiopian green */
            --secondary: #FFD700; /* Ethiopian yellow */
            --accent: #DA291C; /* Ethiopian red */
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Noto Sans Ethiopic', 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            min-height: 100vh;
            padding: 16px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            background: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 100, 0, 0.2);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 16px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .transfers-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
        }
        
        .section-title h2 {
            color: var(--primary);
            font-size: 18px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .transfer-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        
        .transfer-item:hover {
            background: #f9f9f9;
        }
        
        .transfer-info {
            flex: 1;
        }
        
        .transfer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .bank-name {
            font-weight: bold;
            color: var(--primary);
            font-size: 14px;
        }
        
        .transfer-amount {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary);
            text-align: right;
        }
        
        .transfer-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .transfer-date {
            font-size: 11px;
            color: #999;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .status-pending {
            background: var(--warning);
            color: #000;
        }
        
        .status-verified {
            background: var(--success);
            color: white;
        }
        
        .status-fraud {
            background: var(--danger);
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 48px;
            color: #ccc;
            margin-bottom: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,100,0,0.3);
            cursor: pointer;
            border: none;
        }
        
        .refresh-btn {
            background: transparent;
            border: none;
            color: var(--primary);
            font-size: 20px;
            cursor: pointer;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .spinning {
            animation: spin 1s linear infinite;
        }
        
        /* Amharic font support */
        @font-face {
            font-family: 'Noto Sans Ethiopic';
            src: url('https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic&display=swap');
        }
        
        .amharic {
            font-family: 'Noto Sans Ethiopic', 'Segoe UI', sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="amharic">üè¶ ·ã®·â£·äï·ä≠ ·âµ·à´·äï·àµ·çà·à≠ ·ã≥·àΩ·â¶·à≠·ãµ</h1>
            <p class="amharic">·â†·âÄ·å•·â≥ ·ã®·âµ·à´·äï·àµ·çà·à≠ ·àõ·à≥·ãà·âÇ·ã´ ·ä≠·âµ·âµ·àç</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-amount">ETB 0</div>
                <div class="stat-label amharic">·å†·âÖ·àã·àã ·àò·å†·äï</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-transfers">0</div>
                <div class="stat-label amharic">·å†·âÖ·àã·àã ·âµ·à´·äï·àµ·çà·àÆ·âΩ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="today-amount">ETB 0</div>
                <div class="stat-label amharic">·ã®·ãõ·à¨ ·àò·å†·äï</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="verified-count">0</div>
                <div class="stat-label amharic">·ã®·â∞·å†·â†·âÅ</div>
            </div>
        </div>
        
        <div class="transfers-section">
            <div class="section-title">
                <h2 class="amharic">üìã ·ã®·âÖ·à≠·â• ·âµ·à´·äï·àµ·çà·àÆ·âΩ</h2>
                <button class="refresh-btn" id="refreshBtn">‚Üª</button>
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active amharic" data-filter="all">·àÅ·àâ·àù</button>
                <button class="filter-btn amharic" data-filter="pending">·â†·àò·å†·â£·â†·âÖ ·àã·ã≠</button>
                <button class="filter-btn amharic" data-filter="verified">·ã®·â∞·å†·â†·âÅ</button>
                <button class="filter-btn amharic" data-filter="fraud">·ä†·àã·åç·â£·âµ</button>
                <button class="filter-btn amharic" data-filter="telebirr">üì± Telebirr</button>
                <button class="filter-btn amharic" data-filter="cbe">üè¶ CBE</button>
            </div>
            
            <div id="transfers-container">
                <div class="loading amharic">·âµ·à´·äï·àµ·çà·àÆ·âΩ ·â†·àò·å´·äï ·àã·ã≠...</div>
            </div>
        </div>
    </div>
    
    <button class="fab" id="addTransferBtn" title="·ä†·ã≤·àµ ·âµ·à´·äï·àµ·çà·à≠ ·å®·àù·à≠">
        <span class="amharic">+</span>
    </button>
    
    <script>
        const tg = window.Telegram.WebApp;
        const API_BASE = 'https://pssbingo.vercel.app/';
        const WS_URL = 'wss://pssbingo.vercel.app/';
        
        let userId = null;
        let transfers = [];
        let ws = null;
        let currentFilter = 'all';
        
        // Initialize Telegram Web App
        tg.expand();
        tg.BackButton.hide();
        tg.setHeaderColor('#006400');
        tg.setBackgroundColor('#f5f7fa');
        
        // Get user from Telegram
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            userId = tg.initDataUnsafe.user.id;
            const userName = tg.initDataUnsafe.user.first_name;
            document.querySelector('.header p').textContent = 
                `·à∞·àã·àù ${userName} üëã ‚Ä¢ ·â†·âÄ·å•·â≥ ·ã®·âµ·à´·äï·àµ·çà·à≠ ·àõ·à≥·ãà·âÇ·ã´ ·ä≠·âµ·âµ·àç`;
        }
        
        // Connect to WebSocket
        function connectWebSocket() {
            if (!userId) return;
            
            ws = new WebSocket(`${WS_URL}/${userId}`);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                sendPing();
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (e) {
                    console.error('Error parsing WebSocket message:', e);
                }
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }
        
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'new_transfer':
                    addNewTransfer(data.data);
                    updateStats();
                    showNotification('·ä†·ã≤·àµ ·âµ·à´·äï·àµ·çà·à≠ ·â∞·ãà·àµ·ã∑·àç! ‚úÖ');
                    break;
                    
                case 'pong':
                    // Keep connection alive
                    setTimeout(sendPing, 25000);
                    break;
                    
                default:
                    console.log('Unknown message type:', data.type);
            }
        }
        
        function sendPing() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'ping' }));
            }
        }
        
        // Fetch transfers from API
        async function fetchTransfers() {
            if (!userId) return;
            
            try {
                const response = await fetch(`${API_BASE}/transfers?user_id=${userId}&limit=50`);
                const data = await response.json();
                transfers = data.transfers || [];
                renderTransfers();
            } catch (error) {
                console.error('Error fetching transfers:', error);
                showError('·âµ·à´·äï·àµ·çà·àÆ·âΩ·äï ·àà·àõ·àù·å£·âµ ·àµ·àÖ·â∞·âµ ·â∞·çà·å•·àØ·àç');
            }
        }
        
        // Fetch statistics
        async function fetchStats() {
            if (!userId) return;
            
            try {
                const response = await fetch(`${API_BASE}/transfers/stats/${userId}`);
                const stats = await response.json();
                
                document.getElementById('total-amount').textContent = 
                    `ETB ${stats.total_amount_etb.toLocaleString('en-ET')}`;
                document.getElementById('total-transfers').textContent = stats.total_transfers;
                document.getElementById('today-amount').textContent = 
                    `ETB ${stats.today_amount.toLocaleString('en-ET')}`;
                document.getElementById('verified-count').textContent = stats.verified_count;
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }
        
        function renderTransfers() {
            const container = document.getElementById('transfers-container');
            
            if (!transfers.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="amharic">üì≠</div>
                        <h3 class="amharic">·àù·äï·àù ·âµ·à´·äï·àµ·çà·à≠ ·ã®·àà·àù</h3>
                        <p class="amharic">·ã®·â£·äï·ä≠ ·àõ·à≥·ãà·âÇ·ã´ ·àò·àç·ãï·ä≠·âµ ·ãà·ã∞ ·â¶·âµ ·ã≠·àò·àç·à±</p>
                    </div>
                `;
                return;
            }
            
            // Filter transfers
            let filteredTransfers = transfers;
            if (currentFilter === 'pending') {
                filteredTransfers = transfers.filter(t => t.status === 'pending_verification');
            } else if (currentFilter === 'verified') {
                filteredTransfers = transfers.filter(t => t.status === 'verified');
            } else if (currentFilter === 'fraud') {
                filteredTransfers = transfers.filter(t => t.status === 'fraud');
            } else if (currentFilter === 'telebirr') {
                filteredTransfers = transfers.filter(t => 
                    t.bank_name.toLowerCase().includes('telebirr') || 
                    t.bank_name.toLowerCase().includes('birr')
                );
            } else if (currentFilter === 'cbe') {
                filteredTransfers = transfers.filter(t => 
                    t.bank_name.toLowerCase().includes('cbe') || 
                    t.bank_name.toLowerCase().includes('commercial')
                );
            }
            
            container.innerHTML = filteredTransfers.map(transfer => `
                <div class="transfer-item" data-id="${transfer.reference}">
                    <div class="transfer-info">
                        <div class="transfer-header">
                            <div class="bank-name amharic">${transfer.bank_name}</div>
                            <div class="transfer-amount">ETB ${transfer.amount.toLocaleString('en-ET')}</div>
                        </div>
                        <div class="transfer-details amharic">
                            ${transfer.description || '·âµ·à´·äï·àµ·çà·à≠'}
                            ${transfer.account_number ? `‚Ä¢ Acc: ${transfer.account_number}` : ''}
                            ${transfer.phone_number ? `‚Ä¢ üì± ${transfer.phone_number}` : ''}
                        </div>
                        <div class="transfer-date">
                            ${formatDate(transfer.date)} ‚Ä¢ Ref: ${transfer.reference}
                        </div>
                        <div class="status-badge status-${transfer.status} amharic">
                            ${getStatusText(transfer.status)}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function getStatusText(status) {
            const statusMap = {
                'pending_verification': '·â†·àò·å†·â£·â†·âÖ ·àã·ã≠',
                'verified': '·ã®·â∞·å†·â†·âÄ',
                'fraud': '·ä†·àã·åç·â£·âµ',
                'cancelled': '·â∞·à∞·à≠·ãü·àç'
            };
            return statusMap[status] || status;
        }
        
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('am-ET', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }
        
        function addNewTransfer(transfer) {
            transfers.unshift(transfer);
            renderTransfers();
        }
        
        function updateStats() {
            fetchStats();
        }
        
        function showNotification(message) {
            tg.showPopup({
                title: '·àõ·à≥·ãà·âÇ·ã´',
                message: message,
                buttons: [{ type: 'ok', text: '·ä•·à∫' }]
            });
        }
        
        function showError(message) {
            tg.showPopup({
                title: '·àµ·àÖ·â∞·âµ',
                message: message,
                buttons: [{ type: 'ok', text: '·ä•·à∫' }]
            });
        }
        
        // Event Listeners
        document.getElementById('refreshBtn').addEventListener('click', async () => {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('spinning');
            
            await Promise.all([fetchTransfers(), fetchStats()]);
            
            setTimeout(() => {
                btn.classList.remove('spinning');
            }, 500);
        });
        
        document.getElementById('addTransferBtn').addEventListener('click', () => {
            tg.showPopup({
                title: '·ä†·ã≤·àµ ·âµ·à´·äï·àµ·çà·à≠',
                message: '·ã®·â£·äï·ä≠ ·àõ·à≥·ãà·âÇ·ã´ ·àò·àç·ãï·ä≠·âµ ·ãà·ã∞ @YourBotName ·â¶·âµ ·ã≠·àò·àç·à±',
                buttons: [{ type: 'close' }]
            });
        });
        
        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                renderTransfers();
            });
        });
        
        // Initialize
        async function init() {
            tg.ready();
            await Promise.all([fetchTransfers(), fetchStats()]);
            connectWebSocket();
        }
        
        init();
    </script>
</body>
</html>